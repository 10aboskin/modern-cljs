# Tutorial 11 - A deeper understanding of Domina Events

In the [latest tutorial][1] we introduced the ajax model of
communication between the browser and the server by exploiting the
[shoreleave-remote-ring][2] and [shoreleave-remote][3] libraries.

In this and the successive tutorials we're going to strengthen our ajax
understanding by extending its usage to the `Login Form` we faced
starting from the [4th Tutorial][4].

# Introduction

The following picture shows our old `Login Form` friend.

![Login Form][5]

As you perhaps remember from the [4th Tutorial][9], we want to adhere to
the [progressive enhancement][6] strategy which allows any browser to
access our login form, regardless of the browser capabilities.

The lowest experience is the one offered by a web application when the
browser does not support JS (or it has been disabled by the user). The
highest experience is the one offered by a web application when the
the browser support JS and the application uses the Ajax communication
model.

Generally speaking, you should always start by implementing the
application by supportingthe lowest user experience, then step to the
next layer by supporting JS and finally step to the ajax model of
communication for supporting the highest user experience.

Been this series of tutorials mostly about CLJS and not about CLJ, we
jumped over the layer representating the lowest experienced. Yet, as
we will see in successives tutorials, we're going to fill that gap.

# Line up Login Form with Shopping Calculator Form

The [9th tutorial][7] left to the smart user the exercise of applying
to the `Login Form` the same kind of DOM manipoluation used in
implenting the `Shopping Calculator`.

Let's now make together the first part of that not so easy homework. We
start by reviewing the html code of the `login-dbg.html`.

```html
<!doctype html>
<html lang="en">
<head>
...
...
</head>
<body>
    <!-- Script 2.2 - login-dbg.html -->
    <form action="login.php" method="post" id="loginForm" novalidate>
        <fieldset>
            <legend>Login</legend>
            ...
            ...
            <div>
              <label for="submit"></label>
              <input type="submit" value="Login &rarr;" id="submit">
            </div>

        </fieldset>
    </form>
    <script src="js/modern_dbg.js"></script>
    <script>
      modern_cljs.login.init();
    </script>
</body>
</html>
```

As you remember, when we reviewd the Shopping Calculator code, we started
by changing the `type` attribute of the Shopping form's button from
`submit` to `button`. By having decided to adhere to progressive
enhancement strategy, this is not something that we should have done,
because a plain [button type][8] is not going anywhere without JS been
enabled in the browser. So we have to stay with the `submit` type of
botton.

## First try

Let's start by lining up the `login.cljs` with the programming style we
adopted for the Shopping Calculator. First we want to substitute any JS
interop call with a more clojure-ish one by using domina library. Open
`login.cljs` file and change the `init` function as follows.

```clojure
(defn ^:export init []
  ;; verify that js/document exists and that it has a getElementById
  ;; property
  (if (and js/document
           (aget js/document "getElementById"))
    (listen! (by-id "submit") :click validate-form)))
```

First you should note that domina and the underlying Google Closure
Library do not directly support the `:submit` event. We then had to
attach the `validate-form` to the `:click` event of the `submit` button
instead of attaching it to the `loginForm` as before.

Now compile and run the application as usual

```bash
$ lein cljsbuild clean # to clean any previous CLJS compilation
$ lein cljsbuild once dev # to compile just the `dev` build
$ lein ring server-headless #to lunch the ring/compjure server
```

Then visit [login-dbg.html][10] and do not fill any field (or fill just
one of them). The application reacts by showing you the usual `alert`
window that remember you to complete the form. Click the `OK` button and
be prepared to an unexpected result. Instead of showing again the
`loginForm` to allow the user to complete it, the process flows directly
to the default `action` attribute of the form which, by calling an
inesitent server-side script (i.e. `login.php`) return the `Page not
found` message generated by the ring/compjure server.

## Prevent the default

Take a look at the [domina.events][11] source code by pointing your
attention to the private `create-listener-function`, you will understand
a wonderful clojure-ish programming style which, by using the anonymous
reification, allows you to attach a predefined protocol, that means a
set of functions, to whatever you want. Just beatuful. Anyway, we're not
here to discuss programming style, we're here to solve the problem of
preventing the `action` attached to a form to be fired when the user has
not filled the required field. First we have to modify the `init`
function as follows:

```clojure
(defn ^:export init []
  (if (and js/document
           (aget js/document "getElementById"))
    (listen! (by-id "submit") :click (fn [e] (validate-form e)))))
```

We passed an event argument to the `validate-form` by wrapping it
inside an anonymous function.

Let's now see the new `validate-form` definition:

```clojure
(defn validate-form [e]
  (let [email (by-id "email")
        password (by-id "password")]
    (if (and (> (count (value email)) 0)
             (> (count (value password)) 0))
      true
      (do
        (prevent-default e)
        (js/alert "Please, complete the form!")
        false))))
```

We added the `prevent-default` function call and passed to it the event
`e` which, thanks to the anounymous reification implemented in the
`create-listener-function`, is now compliant whith the `Event`
protocol. Note that the call to the `prevent-default` function has been
positioned in the `false` branch of the `if` condition. If both `email`
and `password` pass the test condition, the `action` attached to the
`loginForm` will still be fired.

As usual let's test what we did, but before that, remeber to udpate the
namespace declaration by adding the `prevent-default` symbol to the
`:refer` section of `domina.events` namespace.

```clojure
(ns modern-cljs.login
  (:require [domina :refer [by-id value log]]
            [domina.events :refer [listen! event-type prevent-default]]))
```

You can now procede with the verification.

```bash
$ lein cljsbuild once dev
$ lein ring server-headless
```

Now visit `login-dbg.html` and verify that everything now works as
expected.

The approach followed in this tutorial has to be applied anytime you want
to adhere with the prograssive enhancement strategy.

# Next step - TBD

TBD

# License

Copyright Â© Mimmo Cosenza, 2012-13. Released under the Eclipse Public
License, the same as Clojure.

[1]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-10.md
[2]: https://github.com/shoreleave/shoreleave-remote-ring
[3]: https://github.com/shoreleave/shoreleave-remote#shoreleave
[4]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-10.md
[5]: https://raw.github.com/magomimmo/modern-cljs/master/doc/images/login-form.png
[6]: http://en.wikipedia.org/wiki/Progressive_enhancement
[7]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-9.md
[8]: http://stackoverflow.com/questions/290215/difference-between-input-type-button-and-input-type-submit
[9]: https://github.com/magomimmo/modern-cljs/blob/master/doc/tutorial-4.md
[10]: bbb
[11]: http://localhost:3000/login-dbg.html
[12]: https://github.com/levand/domina/blob/master/src/cljs/domina/events.cljs
